{% import _self as self %}

<div class="island">
    <div>
        {% if panel_details.getEpisode().isTleo() %}
            <h1 class="no-margin visually-hidden">{{ panel_details.getEpisode().getTitle() }}</h1>
        {% else %}
            <h1 class="no-margin">{{ panel_details.getEpisode().getTitle() }}</h1>
            <div class="gamma">
                {{ ds_shared('entityContext', panel_details.getEpisode(), {'include_self': false}) }}

                {% if panel_details.getEpisode().getPosition() and panel_details.getEpisode().getParent().getExpectedChildCount() %}
                    {% if panel_details.getEpisode().getParent().isTleo() %}
                        <span>
                            {{ tr('episode_number', {'%1': panel_details.getEpisode().getPosition(), '%2': panel_details.getEpisode().getParent().getExpectedChildCount()}) }}
                        </span>
                    {% else %}
                        <span class="inset">
                            {{ tr('episode_number', {'%1': panel_details.getEpisode().getPosition(), '%2': panel_details.getEpisode().getParent().getExpectedChildCount()}) }}
                        </span>
                    {% endif %}
                {% endif %}
            </div>
        {% endif %}
    </div>
    <div class="grid-wrapper">
        <div class="grid 2/3@bpw 3/4@bpe">
            {{ self.intro(panel_details.getEpisode()) }}
        </div>
        <div class="grid 1/3@bpw 1/4@bpe">
            {{ self.additionalInfo(panel_details) }}
        </div>
    </div>
</div>

{% macro additionalInfo(presenter) %}
    <div class="map__intro">
        {% if presenter.getEpisode().getReleaseDate() and not presenter.hasPreviousBroadcast() %}
            <div class="episode-panel__meta">
                <span class="visually-hidden">{{ tr('release_date', {'%1': ''}) }}</span>
                <time datetime="{{ presenter.getReleaseDate()|local_date('Y-m-d') }}">{{ presenter.getReleaseDate()|local_date_intl('dd MMMM Y') }}</time>
            </div>
        {% endif %}
        {% if presenter.getEpisode().isStreamable() %}
            <p class="episode-panel__meta">
                {% if presenter.isAvailableIndefinitely() %}
                    {{ tr('available_now') }}
                {% else %}
                    <span title="{{ presenter.getEpisode().streamableUntil()|local_date_intl('EEE dd MMMM yyyy, HH:mm') }}">{{ presenter.getStreamableTimeRemaining() }}</span>
                {% endif %}
            </p>
        {% endif %}

        {% if presenter.getEpisode().getDuration() %}
            <p class="episode-panel__meta">
                {{ gelicon('core', 'duration', 'gelicon--centi gelicon--leading') }}{{ presenter.getDuration() }}
            </p>
        {% endif %}
        {% if presenter.getEpisode().isStreamableAlternatate() and presenter.getEpisode().isTv() %}
            <p class="episode-panel__meta delta">
                {% if presenter.hasAvailableSignedVersion() %}
                    <a class="text--no-ul" title="{{ tr('signed') }}" href="{{ path('iplayer_play', {'pid': presenter.getEpisode().getPid(), 'version': 'sign'}) }}">
                        {#TODO not sure about how to size this GelIcon...#}
                        {{ gelicon('audio-visual', 'sign-language-35', 'gelicon--gamma') }}<span class="visually-hidden">{{ tr('signed') }}</span>
                    </a>
                {% endif %}
                {% if presenter.hasAvailableAudioDescribedVersion() %}
                    <a class="text--no-ul" title="{{ tr('audio_described') }}" href="{{ path('iplayer_play', {'pid': presenter.getEpisode().getPid(), 'version': 'ad'}) }}">
                        {#TODO not sure about how to size this GelIcon...#}
                        {{ gelicon('audio-visual', 'audio-description', 'gelicon--gamma') }}<span class="visually-hidden">{{ tr('audio_described') }}</span>
                    </a>
                {% endif %}
            </p>
        {% endif %}
    </div>
{% endmacro %}

{% macro intro(episode) %}
    <div class="episode-panel__intro">
        {% if episode.getLongestSynopsis() %}
            <div class="map__intro__synopsis centi">{{ ds_shared('synopsis', episode.getSynopses(), 300) }}</div>
        {% endif %}
        {% if episode.isRadio() %}
            <div class="favourites-button buttons--favourites-small"></div>
        {% endif %}
        {#{% if episode.getDownloadableVersion() %}#}
            {#@TODO add podcast logic#}
        {#{% endif %}#}
    </div>
{% endmacro %}
